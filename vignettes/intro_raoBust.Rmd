---
title: "Introduction to raoBust"
author: "Sarah Teichman"
date: "`r Sys.Date()`"
output: rmarkdown::html_vignette
vignette: >
  %\VignetteIndexEntry{Introduction to raoBust}
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteEncoding{UTF-8}
---

```{r, include = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>"
)
```

We'll start by installing `raoBust` if we haven't already, and then loading it. 

```{r setup}
# if (!require("remotes", quietly = TRUE))
#     install.packages("remotes")
# 
# remotes::install_github("statdivlab/raoBust")

library(raoBust)
library(geeasy) # also load geeasy, which raoBust uses in the back-end
```

## Introduction

`raoBust` is an R package that implements robust Wald tests and Rao (score) tests for generalized linear models. We like robust tests because they are robust (retain error rate control) to many forms of model misspecification. We especially like robust Rao tests because they have strong error rate control in small samples. 

`raoBust` implements robust tests for coefficients in Poisson GLMs (log link), binomial GLMs (logit link), linear models (identity link), and multinomial GLMs (log link).

## Model fitting

### GLMs

We will demonstrate the function `glm_test()` in `raoBust` using the `light_presence` dataset.

```{r}
data("light_presence")
head(light_presence)
```

This dataset provides presence/absence data for COG 4251 with a set of *Prochlorococcus* genomes. COG 4251 has the function Bacteriophytochrome (light-regulated signal transduction histidine kinase). We would like to test whether the presence or absence of this COG is associated with a genome being from a high light or low light condition. We will use a binomial GLM model to investigate this. 

```{r, message = FALSE}
glm_test(formula = presence ~ light, data = light_presence, family = binomial(link = "logit"))
```

From the output, we can see that we have an estimated log odds of COG 4251 being present in a low light compared to a high light condition of $-20.75$, with a robust Rao test p-value of $0.003$. This means that COG 4251 is present far less often in low light compared to high light. This makes sense if we look at the presence/absence breakdown for this COG. 

```{r}
table(light_presence[, c("presence", "light")])
```

We can see that this COG is present in all samples from the high light condition, and only in 5 out of 11 samples from the low light condition. 

We can compare the results from `glm_test()` to the results we would get if we ran a typical `glm()`.

```{r}
summary(glm(formula = presence ~ light, data = light_presence, family = binomial(link = "logit")))
```

Here we see the same estimates, but `glm` does not give us robust standard errors or robust Wald and Rao tests. 

### GEEs, accounting for clusters

Next, we will use the function `gee_test()` to account for clustered observations. We will apply this to the `ddPCR` dataset, which gives digital droplet PCR measurements from participants in a study of people living with cystic fibrosis. 

```{r}
data("ddPCR")
head(ddPCR)
```

We will fit a Poisson GEE model to estimate and test the expected fold-difference in the `ddPCR` measurement associated with whether or not the participant is receiving the treatment, accounting for the specimen type (specimens are collected either from sputum or saliva). We choose Poisson regression because we want to estimate a fold-difference in means, and because we are using robust tests we will not worry about whether we actually expect `ddPCR` measurements to follow a Poisson distribution. We use a GEE instead of a GLM because we have multiple observations from the same samples. 

```{r}
gee_test(formula = Value ~ Treatment + SpecimenType, data = ddPCR, family = poisson(link = "log"), id = Subject)
```

We estimate an expected fold-difference of $\exp(-0.32) = 0.72$ in the `ddPCR` measurement for participants who have received the treatment, accounting for sample type, with a robust Rao p-value of $0.44$. We can compare these results to what we would get if we ran a GLM, ignoring correlation of samples from the same subjects. 

```{r}
glm_test(formula = Value ~ Treatment + SpecimenType, data = ddPCR, family = poisson(link = "log"))
```

We can see that we get the same estimates as in the `gee_test()`, but different standard errors and p-values because we have not appropriately accounted for the clustering. 
